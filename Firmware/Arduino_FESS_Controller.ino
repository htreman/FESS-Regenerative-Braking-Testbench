/*********************************************************************
 * Flywheel Energy Storage System (FESS)
 * Basic Control Algorithm for Regenerative Braking Experiments
 *
 * This firmware implements a simple speed-tracking and braking
 * control routine for a laboratory-scale FESS test bench.
 *********************************************************************/

/* ===========================
   Target Velocities
   =========================== */
const PROGMEM uint16_t vel[] = {  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 306, 506, 692, 891, 1084, 1262, 1290,
                                  1345, 1524, 1593, 1641, 1648, 1620, 1579, 1538, 1503, 1462, 1269, 1125, 1125, 1146, 1166, 1201, 1276, 1414, 1551, 1661, 1675, 1661, 1654, 1565, 1407, 1276, 1187, 1187, 1317, 1462,
                                  1586, 1696, 1765, 1792, 1813, 1820, 1792, 1785, 1799, 1806, 1799, 1792, 1792, 1826, 1861, 1868, 1847, 1813, 1820, 1847, 1888, 1888, 1868, 1895, 1937, 1992, 2067, 2115, 2150, 2170,
                                  2191, 2212, 2212, 2198, 2191, 2184, 2191, 2219, 2191, 2157, 2129, 2150, 2184, 2212, 2225, 2232, 2225, 2191, 2150, 2157, 2177, 2212, 2246, 2287, 2315, 2329, 2315, 2280, 2067, 1840,
                                  1613, 1386, 1159, 932, 705, 478, 251, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                                  100, 100, 100, 100, 100, 100, 100, 100, 100, 327, 554, 781, 1008, 1235, 1462, 1627, 1771, 1875, 1916, 1868, 1826, 1799, 1820, 1833, 1847, 1875, 1971, 1923, 1751, 1661, 1434, 1317,
                                  1283, 1345, 1379, 1476, 1627, 1785, 1978, 2198, 2404, 2590, 2666, 2803, 2886, 2996, 3092, 3202, 3264, 3319, 3367, 3367, 3353, 3347, 3333, 3333, 3333, 3333, 3333, 3347, 3360, 3395,
                                  3436, 3477, 3505, 3539, 3580, 3608, 3642, 3690, 3759, 3821, 3856, 3876, 3883, 3876, 3856, 3856, 3869, 3890, 3917, 3931, 3959, 3972, 3993, 4000, 4000, 3986, 3986, 3986, 3986, 3986,
                                  3986, 3979, 3959, 3938, 3890, 3856, 3828, 3814, 3794, 3787, 3807, 3814, 3821, 3821, 3801, 3773, 3746, 3718, 3684, 3704, 3677, 3670, 3656, 3642, 3649, 3663, 3684, 3711, 3746, 3780,
                                  3814, 3876, 3911, 3924, 3952, 3952, 3938, 3897, 3849, 3787, 3711, 3642, 3642, 3642, 3615, 3546, 3539, 3546, 3539, 3512, 3505, 3505, 3505, 3477, 3443, 3408, 3347, 3271, 3195, 3113,
                                  3030, 2954, 2872, 2748, 2645, 2521, 2425, 2335, 2267, 2205, 2198, 2163, 2095, 1992, 1806, 1579, 1483, 1414, 1372, 1269, 1166, 960, 843, 650, 423, 196, 100, 100, 100, 100, 100, 100, 100
                                  , 100, 100, 100, 100, 100, 100, 100, 169, 396, 623, 850, 1077, 1290, 1476, 1648, 1730, 1833, 1930, 2033, 2163, 2219, 2274, 2308, 2356, 2411, 2473, 2480, 2501, 2494, 2473, 2487, 2542,
                                  2576, 2576, 2576, 2576, 2576, 2576, 2583, 2604, 2611, 2604, 2576, 2514, 2446, 2404, 2260, 2095, 1868, 1682, 1496, 1304, 1097, 925, 698, 471, 244, 100, 100, 100, 100, 100, 100, 279,
                                  506, 733, 960, 1187, 1414, 1641, 1820, 1861, 1992, 2095, 2163, 2170, 2163, 2143, 2115, 2081, 2026, 1820, 1593, 1366, 1139, 912, 685, 458, 231, 100, 100, 100, 100, 100, 100, 100, 100,
                                  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 327, 554, 781, 1008, 1235, 1462, 1689, 1916, 2012, 2102, 2267, 2370, 2411, 2494, 2514, 2549, 2583, 2576, 2583, 2590, 2576, 2556,
                                  2576, 2576, 2549, 2542, 2535, 2521, 2521, 2521, 2521, 2521, 2521, 2507, 2514, 2521, 2542, 2521, 2507, 2507, 2507, 2494, 2480, 2473, 2404, 2301, 2170, 2026, 1854, 1648, 1462, 1235,
                                  1008, 808, 595, 375, 169, 100, 100, 100, 100, 100, 100, 183, 341, 478, 547, 685, 760, 822, 919, 1063, 1201, 1317, 1407, 1483, 1544, 1613, 1682, 1737, 1785, 1813, 1820, 1820, 1820, 1820,
                                  1820, 1820, 1861, 1875, 1888, 1861, 1833, 1820, 1820, 1820, 1778, 1689, 1462, 1235, 1008, 781, 554, 327, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                                  327, 554, 781, 994, 1104, 1201, 1269, 1269, 1269, 1304, 1317, 1317, 1304, 1269, 1262, 1242, 1269, 1276, 1269, 1242, 1235, 1235, 1242, 1269, 1311, 1372, 1421, 1489, 1544, 1551, 1558,
                                  1586, 1613, 1641, 1648, 1648, 1648, 1661, 1730, 1826, 1888, 1923, 1957, 1895, 1668, 1441, 1214, 987, 760, 533, 306, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                                  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 238, 410, 637, 802, 960, 1063, 1152, 1304, 1448, 1544, 1627, 1703, 1785, 1840, 1861, 1888, 1895, 1902, 1902, 1916, 1923, 1923,
                                  1888, 1854, 1723, 1572, 1372, 1228, 1097, 898, 698, 499, 341, 238, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 196, 327, 403, 547, 733, 877, 1029, 1104, 1228, 1249,
                                  1235, 1235, 1352, 1421, 1483, 1579, 1648, 1648, 1620, 1661, 1703, 1716, 1648, 1586, 1510, 1338, 1132, 925, 719, 526, 410, 306, 244, 134, 134, 320, 547, 760, 960, 1063, 1201, 1338, 1448,
                                  1579, 1689, 1785, 1854, 1923, 1964, 1998, 2019, 2047, 2067, 2067, 2047, 2040, 2026, 1992, 1943, 1854, 1716, 1579, 1407, 1235, 1125, 960, 747, 526, 306, 203, 203, 134, 100, 306, 533, 760,
                                  987, 1187, 1304, 1366, 1441, 1524, 1613, 1696, 1820, 1923, 1992, 2026, 2047, 2088, 2088, 2088, 2081, 2060, 2047, 2047, 2047, 2040, 1998, 1992, 1992, 1992, 1992, 1992, 1992, 1998, 2026,
                                  2060, 2163, 2232, 2301, 2370, 2370, 2411, 2439, 2459, 2452, 2439, 2439, 2432, 2411, 2377, 2370, 2335, 2301, 2294, 2274, 2267, 2205, 2163, 2157, 2157, 2157, 2157, 2136, 2129, 2129, 2115,
                                  2088, 2040, 2005, 1957, 1854, 1730, 1613, 1510, 1421, 1421, 1483, 1538, 1572, 1613, 1654, 1696, 1751, 1820, 1888, 1930, 1930, 1943, 1957, 1971, 2012, 2033, 2081, 2088, 2095, 2102, 2095,
                                  2033, 1992, 1957, 1875, 1820, 1785, 1806, 1826, 1854, 1868, 1902, 1950, 1992, 2012, 2053, 2095, 2108, 2102, 2095, 2088, 2060, 2033, 2026, 2026, 1998, 1971, 1930, 1957, 1992, 2012, 2026,
                                  2026, 2026, 2026, 2005, 1985, 1950, 1930, 1923, 1923, 1923, 1909, 1902, 1902, 1881, 1861, 1861, 1881, 1875, 1854, 1792, 1716, 1627, 1586, 1586, 1593, 1654, 1710, 1751, 1765, 1778, 1813,
                                  1826, 1833, 1840, 1854, 1833, 1820, 1820, 1820, 1799, 1785, 1771, 1771, 1785, 1820, 1820, 1792, 1792, 1758, 1785, 1826, 1861, 1826, 1751, 1613, 1483, 1262, 1035, 808, 581, 354, 128, 100,
                                  100, 100, 238, 465, 692, 919, 1146, 1304, 1379, 1476, 1551, 1613, 1682, 1785, 1909, 1992, 2033, 2053, 2060, 2060, 2060, 2005, 1992, 1971, 1943, 1923, 1888, 1868, 1833, 1751, 1613, 1579,
                                  1579, 1599, 1648, 1682, 1668, 1668, 1682, 1661, 1661, 1661, 1716, 1751, 1792, 1806, 1826, 1854, 1861, 1854, 1820, 1758, 1730, 1696, 1675, 1648, 1613, 1586, 1510, 1304, 1077, 850, 623,
                                  396, 169, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 183, 375, 602, 829, 1056, 1269,
                                  1372, 1476, 1599, 1682, 1751, 1806, 1861, 1923, 1943, 1985, 2019, 2047, 2026, 1992, 1957, 1957, 1909, 1785, 1648, 1579, 1517, 1338, 1132, 946, 863, 829, 788, 753, 726, 698, 692, 705, 719,
                                  698, 692, 650, 581, 444, 389, 279, 169, 100, 107, 141, 210, 348, 575, 788, 980, 1063, 1097, 1201, 1345, 1476, 1544, 1558, 1565, 1572, 1593, 1648, 1682, 1737, 1785, 1820, 1813, 1806, 1820,
                                  1847, 1875, 1888, 1916, 1930, 1950, 1957, 1957, 1957, 1950, 1943, 1943, 1923, 1916, 1888, 1854, 1792, 1716, 1579, 1476, 1304, 1201, 1063, 836, 609, 382, 155, 100, 100, 100, 100, 100, 100,
                                  100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 244, 471, 698, 925, 1152, 1379, 1551, 1682, 1716, 1682, 1648, 1476, 1249, 1022, 795, 568, 341, 114, 100, 100, 100, 100, 100, 100, 100, 100,
                                  100, 100, 114, 203, 341, 547, 774, 925, 987, 994, 967, 980, 1001, 1001, 1063, 1166, 1269, 1379, 1455, 1544, 1579, 1599, 1599, 1579, 1558, 1579, 1599, 1613, 1606, 1593, 1579, 1579, 1572,
                                  1483, 1441, 1421, 1448, 1462, 1476, 1441, 1304, 1166, 994, 788, 650, 513, 375, 272, 148, 100, 100, 100, 100, 100, 100, 100, 100, 169, 169, 169, 169, 169, 210, 306, 375, 444, 533, 650, 788,
                                  822, 753, 685, 623, 705, 857, 1063, 1269, 1441, 1544, 1599, 1627, 1682, 1723, 1758, 1785, 1785, 1751, 1716, 1716, 1716, 1716, 1716, 1716, 1751, 1758, 1785, 1799, 1820, 1847, 1861, 1868,
                                  1888, 1902, 1957, 2012, 2047, 2095, 2102, 2095, 2026, 1799, 1572, 1345, 1118, 891, 664, 437, 210, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100,
                                  100, 100, 100, 100, 100, 100, 100, 203, 430, 657, 884, 1008, 1139, 1256, 1359, 1441, 1496, 1565, 1606, 1620, 1641, 1613, 1586, 1551, 1510, 1476, 1448, 1372, 1304, 1235, 1166, 1063, 857,
                                  650, 458, 272, 100, 100, 100
                               };
/* ===========================
   Pin Definitions
   =========================== */
#define ENCODER_PIN   2   // Infrared tachometer input
#define BOOST_PWM     3   // Boost converter PWM signal
#define PEDAL_PWM     6   // Ground MOSFET PWM signal
#define RELAY_1       8   // Battery / FESS relay
#define RELAY_2       9   // Direction relay 1
#define RELAY_3       10  // Direction relay 2
#define RELAY_4       11  // Direct ground / MOSFET selector

/* ===========================
   System Parameters
   =========================== */
#define NUM_DATA      1370   // Number of target velocity samples
#define RELAY_ON      LOW
#define RELAY_OFF     HIGH

/* ===========================
   Global Variables
   =========================== */
char status;                 // Current operating mode indicator
int  actVel = 0;             // Measured rotational speed [RPM]
int  targetVel;              // Reference rotational speed [RPM]
int  boost;                  // Boost converter control value
int  error;                  // Speed tracking error
int  pedalVal = 0;           // PWM value for ground MOSFET
int  brakeCounter = 0;       // Braking attempt counter
int  rampCounter  = 0;       // Battery brake ramp counter

float I = 0.0;               // Battery current (ADC units)
float V = 0.0;               // Battery voltage (ADC units)

unsigned long tStart;

/* ===========================
   Setup Routine
   =========================== */
void setup() {

  /* Configure Timer2 for high-frequency PWM on pin 3 */
  TCCR2B = (TCCR2B & 0b11111000) | 0x01;   // Prescaler = 1 (~32 kHz)

  /* Pin configuration */
  pinMode(ENCODER_PIN, INPUT);
  pinMode(BOOST_PWM, OUTPUT);
  pinMode(PEDAL_PWM, OUTPUT);

  pinMode(RELAY_1, OUTPUT);
  pinMode(RELAY_2, OUTPUT);
  pinMode(RELAY_3, OUTPUT);
  pinMode(RELAY_4, OUTPUT);

  /* Initialize relays to OFF state */
  digitalWrite(RELAY_1, RELAY_OFF);
  digitalWrite(RELAY_2, RELAY_OFF);
  digitalWrite(RELAY_3, RELAY_OFF);
  digitalWrite(RELAY_4, RELAY_OFF);

  Serial.begin(9600);          // Serial communication
  delay(3000);                 // Battery stabilization delay

  Serial.println("System initialized.");
}

/* ===========================
   Measurement Subroutine
   =========================== */
float readRPM(int prevRPM) {

  /* Read electrical variables */
  I = analogRead(A0);          // Current sensor
  V = analogRead(A3);          // Voltage divider

  /* Measure tachometer interval */
  unsigned long interval = pulseIn(ENCODER_PIN, LOW);
  float rpm = 1.078 * 15e6 / interval;  // Scaling factor from disc pattern

  /* Outlier rejection */
  if (abs(rpm - prevRPM) > 500 || interval < 2500) {
    rpm = prevRPM;
  }

  /* Transmit data for post-processing */
  Serial.print(millis() / 1000.0); Serial.print(",");
  Serial.print(targetVel);          Serial.print(",");
  Serial.print(rpm);                Serial.print(",");
  Serial.print(I);                  Serial.print(",");
  Serial.print(V);                  Serial.print(",");
  Serial.println(status);

  return rpm;
}

/* ===========================
   Main Control Loop
   =========================== */
void loop() {

  for (int i = 0; i <= NUM_DATA; i++) {

    targetVel = pgm_read_word_near(vel + i);
    pedalVal  = 0;
    boost     = 0;

    tStart = millis();

    /* Control interval: 1 second per reference point */
    while (millis() - tStart < 1000) {

      actVel = readRPM(actVel);
      error  = targetVel - actVel;

      /* -------- Acceleration Control -------- */
      if (error > 50) {                    // Coarse control
        digitalWrite(RELAY_1, RELAY_ON);
        digitalWrite(RELAY_2, RELAY_OFF);
        digitalWrite(RELAY_3, RELAY_OFF);
        digitalWrite(RELAY_4, RELAY_OFF);
        delay(100);
        status = 'm';                      // Magenta
        brakeCounter = 0;
      }

      else if (error >= 0 && error <= 50) { // Fine PWM control
        digitalWrite(RELAY_1, RELAY_ON);
        digitalWrite(RELAY_2, RELAY_OFF);
        digitalWrite(RELAY_3, RELAY_OFF);
        digitalWrite(RELAY_4, RELAY_ON);

        pedalVal = min(2 * error, 255);
        analogWrite(PEDAL_PWM, pedalVal);
        delay(100);

        status = 'g';                      // Green
        brakeCounter = 0;
      }

      /* -------- Braking Control -------- */
      if (error < 0) {

        analogWrite(PEDAL_PWM, 0);
        brakeCounter++;

        /* Freewheeling */
        if (brakeCounter <= 10) {
          digitalWrite(RELAY_1, RELAY_ON);
          digitalWrite(RELAY_2, RELAY_OFF);
          digitalWrite(RELAY_3, RELAY_OFF);
          digitalWrite(RELAY_4, RELAY_ON);
          analogWrite(PEDAL_PWM, 0);
          status = 'y';                    // Yellow
        }

        /* Regenerative braking */
        else if (brakeCounter <= 40) {
          digitalWrite(RELAY_1, RELAY_OFF);
          digitalWrite(RELAY_2, RELAY_OFF);
          digitalWrite(RELAY_3, RELAY_OFF);
          analogWrite(BOOST_PWM, 200);
          delay(200);
          analogWrite(BOOST_PWM, 0);
          status = 'b';                    // Blue
        }

        /* Motor braking */
        else if (brakeCounter <= 60) {
          digitalWrite(RELAY_1, RELAY_ON);
          digitalWrite(RELAY_2, RELAY_ON);
          digitalWrite(RELAY_3, RELAY_OFF);
          digitalWrite(RELAY_4, RELAY_OFF);
          delay(100);
          status = 'c';                    // Cyan
        }

        /* Battery-assisted braking */
        else {
          digitalWrite(RELAY_1, RELAY_ON);
          digitalWrite(RELAY_2, RELAY_ON);
          digitalWrite(RELAY_3, RELAY_ON);
          digitalWrite(RELAY_4, RELAY_ON);

          status = 'r';                    // Red
          rampCounter = 0;

          while (actVel - targetVel > 200) {
            actVel = readRPM(actVel);
            rampCounter = min(rampCounter + 1, 255);
            analogWrite(PEDAL_PWM, rampCounter);
            delay(25);
            analogWrite(PEDAL_PWM, 0);
          }

          brakeCounter = 0;
        }
      }
    }
  }
}
